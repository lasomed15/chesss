<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Multiplayer Chess</title>
<style>
body { display:flex; flex-direction:column; align-items:center; font-family:sans-serif; background:#eee; }
h1{margin-top:20px;}
#chessboard{ display:grid; grid-template-columns:repeat(8,60px); grid-template-rows:repeat(8,60px); border:2px solid #333; margin-top:20px;}
.square{width:60px; height:60px; display:flex; justify-content:center; align-items:center; font-size:36px; cursor:pointer;}
.square.black{background:#769656;}
.square.white{background:#eeeed2;}
.selected{border:3px solid red !important;}
.highlight{border:3px solid yellow !important;}
button{margin-top:10px;padding:10px 20px;font-size:16px;}
input[type=range]{margin-top:10px;}
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.22.0/firebase-database-compat.js"></script>
</head>
<body>
<h1>Firebase Multiplayer Chess</h1>
<div id="chessboard"></div>
<p id="status"></p>
<button id="replayBtn">Replay Game</button>
<label>Replay Speed: <span id="speedVal">500ms</span></label>
<input type="range" id="speedSlider" min="100" max="2000" step="100" value="500">

<script>
// --- Firebase setup ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const gameId = "game1"; // Change for multiple rooms

// --- Chess setup ---
const chessboard = document.getElementById('chessboard');
const status = document.getElementById('status');
const replayBtn = document.getElementById('replayBtn');
const speedSlider = document.getElementById('speedSlider');
const speedVal = document.getElementById('speedVal');
let replaySpeed = parseInt(speedSlider.value);
speedSlider.addEventListener('input', ()=>{ replaySpeed=parseInt(speedSlider.value); speedVal.textContent=replaySpeed+'ms'; });

let board = [
  ['♜','♞','♝','♛','♚','♝','♞','♜'],
  ['♟','♟','♟','♟','♟','♟','♟','♟'],
  ['','','','','','','',''],
  ['','','','','','','',''],
  ['','','','','','','',''],
  ['','','','','','','',''],
  ['♙','♙','♙','♙','♙','♙','♙','♙'],
  ['♖','♘','♗','♕','♔','♗','♘','♖']
];
let turn = 'white';
let selected = null;
let moveHistory = [];

// --- Utility ---
function isWhite(p){return ['♙','♖','♘','♗','♕','♔'].includes(p);}
function isBlack(p){return ['♟','♜','♞','♝','♛','♚'].includes(p);}
function isEmpty(r,c){return board[r][c]==='';}
function inBounds(r,c){return r>=0&&r<8&&c>=0&&c<8;}

// --- Draw ---
function drawBoard(highlightSquares=[],highlightMove=null){
  chessboard.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq=document.createElement('div');
      sq.classList.add('square',(r+c)%2===0?'white':'black');
      sq.dataset.row=r; sq.dataset.col=c; sq.textContent=board[r][c];
      if(selected && selected.row===r && selected.col===c) sq.classList.add('selected');
      if(highlightSquares.some(s=>s.row===r && s.col===c)) sq.style.border='3px solid yellow';
      if(highlightMove && ((highlightMove.from.row===r && highlightMove.from.col===c)||(highlightMove.to.row===r && highlightMove.to.col===c))) sq.classList.add('highlight');
      chessboard.appendChild(sq);
    }
  }
  status.textContent=`${turn.charAt(0).toUpperCase()+turn.slice(1)}'s turn`;
}

// --- Legal moves ---
function getLegalMoves(row,col){
  const piece=board[row][col],moves=[]; if(piece==='') return moves;
  const color=isWhite(piece)?'white':'black'; const enemy=color==='white'?isBlack:isWhite;
  if(piece==='♙'){ if(inBounds(row-1,col)&&isEmpty(row-1,col)) moves.push({row:row-1,col}); if(row===6&&isEmpty(row-1,col)&&isEmpty(row-2,col)) moves.push({row:row-2,col}); if(inBounds(row-1,col-1)&&enemy(board[row-1][col-1])) moves.push({row:row-1,col:col-1}); if(inBounds(row-1,col+1)&&enemy(board[row-1][col+1])) moves.push({row:row-1,col:col+1}); }
  if(piece==='♟'){ if(inBounds(row+1,col)&&isEmpty(row+1,col)) moves.push({row:row+1,col}); if(row===1&&isEmpty(row+1,col)&&isEmpty(row+2,col)) moves.push({row:row+2,col}); if(inBounds(row+1,col-1)&&enemy(board[row+1][col-1])) moves.push({row:row+1,col:col-1}); if(inBounds(row+1,col+1)&&enemy(board[row+1][col+1])) moves.push({row:row+1,col:col+1}); }
  if(piece==='♘'||piece==='♞'){ [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(d=>{ const r=row+d[0],c=col+d[1]; if(inBounds(r,c)&&(!board[r][c]||enemy(board[r][c]))) moves.push({row:r,col:c}); }); }
  if(piece==='♖'||piece==='♜'){ [[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{ let r=row+d[0],c=col+d[1]; while(inBounds(r,c)&&(isEmpty(r,c)||enemy(board[r][c]))){ moves.push({row:r,col:c}); if(!isEmpty(r,c)) break; r+=d[0]; c+=d[1]; } }); }
  if(piece==='♗'||piece==='♝'){ [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{ let r=row+d[0],c=col+d[1]; while(inBounds(r,c)&&(isEmpty(r,c)||enemy(board[r][c]))){ moves.push({row:r,col:c}); if(!isEmpty(r,c)) break; r+=d[0]; c+=d[1]; } }); }
  if(piece==='♕'||piece==='♛'){ [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{ let r=row+d[0],c=col+d[1]; while(inBounds(r,c)&&(isEmpty(r,c)||enemy(board[r][c]))){ moves.push({row:r,col:c}); if(!isEmpty(r,c)) break; r+=d[0]; c+=d[1]; } }); }
  if(piece==='♔'||piece==='♚'){ [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d=>{ const r=row+d[0],c=col+d[1]; if(inBounds(r,c)&&(!board[r][c]||enemy(board[r][c]))) moves.push({row:r,col:c}); }); }
  return moves;
}

// --- Check/Checkmate ---
function inCheck(color){ let kingPos; for(let r=0;r<8;r++) for(let c=0;c<8;c++){ if((color==='white'&&board[r][c]==='♔')||(color==='black'&&board[r][c]==='♚')) kingPos={row:r,col:c}; } for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const piece=board[r][c]; if(piece && ((color==='white'&&isBlack(piece))||(color==='black'&&isWhite(piece)))){ const moves=getLegalMoves(r,c); if(moves.some(m=>m.row===kingPos.row&&m.col===kingPos.col)) return true; } } return false; }
function checkMate(color){ for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const piece=board[r][c]; if(piece && ((color==='white'&&isWhite(piece))||(color==='black'&&isBlack(piece)))){ const moves=getLegalMoves(r,c); for(const m of moves){ const backup=board[m.row][m.col]; board[m.row][m.col]=piece; board[r][c]=''; if(!inCheck(color)){ board[r][c]=piece; board[m.row][m.col]=backup; return false; } board[r][c]=piece; board[m.row][m.col]=backup; } } } return true; }

// --- Send move to Firebase ---
function sendMove(from,to,piece){
  const gameRef=db.ref('games/'+gameId);
  gameRef.transaction(game=>{
    if(!game) game={board:board, turn:turn, moveHistory:[]};
    game.board[to.row][to.col]=piece;
    game.board[from.row][from.col]='';
    game.turn=turn==='white'?'black':'white';
    game.moveHistory=game.moveHistory||[];
    game.moveHistory.push({from,to,piece,turn});
    return game;
  });
}

// --- Click handling ---
chessboard.addEventListener('click',e=>{
  const sq=e.target; if(!sq.classList.contains('square')) return;
  const row=parseInt(sq.dataset.row); const col=parseInt(sq.dataset.col);
  const piece=board[row][col];
  if(!selected){ if(piece && ((turn==='white'&&isWhite(piece))||(turn==='black'&&isBlack(piece)))){ selected={row,col}; drawBoard(getLegalMoves(row,col)); } }
  else{
    const moves=getLegalMoves(selected.row,selected.col);
    if(moves.some(m=>m.row===row && m.col===col)){
      const movingPiece=board[selected.row][selected.col];
      if(turn===((isWhite(movingPiece)?'white':'black'))){ // only your turn
        sendMove(selected,{row,col},movingPiece);
      }
      selected=null; drawBoard();
    } else{ selected=null; drawBoard(); }
  }
});

// --- Listen for Firebase updates ---
db.ref('games/'+gameId).on('value',snap=>{
  const data=snap.val();
  if(data){ board=data.board; turn=data.turn; moveHistory=data.moveHistory||[]; drawBoard(); }
});

// --- Replay ---
replayBtn.addEventListener('click',()=>{
  let replayBoard=[
    ['♜','♞','♝','♛','♚','♝','♞','♜'],
    ['♟','♟','♟','♟','♟','♟','♟','♟'],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['♙','♙','♙','♙','♙','♙','♙','♙'],
    ['♖','♘','♗','♕','♔','♗','♘','♖']
  ];
  let i=0;
  const interval=setInterval(()=>{
    if(i>=moveHistory.length){ clearInterval(interval); board=replayBoard.map(r=>[...r]); drawBoard(); return; }
    const move=moveHistory[i];
    replayBoard[move.to.row][move.to.col]=move.from.piece;
    replayBoard[move.from.row][move.from.col]='';
    board=replayBoard.map(r=>[...r]);
    drawBoard([],move);
    i++;
  },replaySpeed);
});

drawBoard();
</script>
</body>
</html>
